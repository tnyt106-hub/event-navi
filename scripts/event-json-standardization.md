# イベントJSON項目の統一方針

このドキュメントは、`scripts/` 配下の各取得スクリプトが出力するイベントJSONの項目を
段階的に統一するための方針と実装手順をまとめたものです。

## 1. 現状の課題

施設ごとにイベント項目のキーが揺れており、特に時間項目で以下の混在が発生しています。

- 旧形式: `time_start`, `time_end`
- 新形式: `open_time`, `start_time`, `end_time`

この揺れにより、後段処理（タグ付与、日付ページ生成、画面表示）で
「どのキーを見ればよいか」がスクリプトごとに変わる問題が起きます。

## 2. 統一後の標準スキーマ（イベント単位）

時間項目は次を標準とします。

- `open_time`: 開場時刻（存在しない場合は `null`）
- `start_time`: 開始時刻（存在しない場合は `null`）
- `end_time`: 終了時刻（存在しない場合は `null`）

補助項目として、既存運用で使っている以下も標準オブジェクトに含めます。

- `source_type`
- `venue_name`
- `status`
- `body`

## 3. 実装方針（段階移行）

### フェーズ1: 共通スキーマで吸収

`scripts/lib/schema.js` の `createEvent()` で、
旧形式 `time_start` / `time_end` を受け取っても、
出力は必ず `start_time` / `end_time` になるように吸収します。

- これにより既存スクレイパーを一括改修しなくても、
  新しく保存されるJSONのキーを先に統一できます。


### 実装ルール: 項目定義はテンプレート1箇所に集約

イベント項目の列挙は `scripts/lib/schema.js` の `EVENT_TEMPLATE` に**1回だけ**記述します。

- `createEvent()` は `EVENT_TEMPLATE` を複製して値を上書きする。
- 新規項目を追加する場合は、まず `EVENT_TEMPLATE` を更新し、
  その後に必要な抽出スクリプト側を更新する。
- これにより、施設ごとの項目漏れ・キー揺れの根本原因（定義の分散）を防ぐ。
- さらに `scripts/lib/io.js` の `writeJsonPretty()` でも `createEvent()` を通して正規化する。
  これにより、個別スクリプトで未統一項目が残っても保存時点で統一できる。

### フェーズ2: 各スクレイパーを順次更新

旧キーで `createEvent()` に渡しているスクリプトを、
順次 `start_time` / `end_time` 渡しに置換します。

- 例: `time_start` → `start_time`
- 例: `time_end` → `end_time`

このフェーズは可読性・保守性のための整理であり、
フェーズ1の時点で出力互換は確保されています。

### フェーズ3: 旧キー運用の終了

すべての取得スクリプト更新後に、
`createEvent()` 内の旧キー吸収（`time_start` / `time_end`）を削除します。

- この時点でキー揺れの後方互換コードをなくし、
  実装をシンプルに保ちます。

## 4. 修正時のチェック項目

1. 新規生成JSONに `time_start` / `time_end` が含まれないこと。
2. `start_time` / `end_time` / `open_time` が必要に応じて `null` で存在すること。
3. `generate-date-pages.js` と `apply-event-tags.js` の時刻処理が崩れていないこと。
4. 既存の施設JSONの構造差分が意図通り（時間キー統一）であること。

## 5. 運用ルール（推奨）

- 新規スクレイパーは必ず標準キー（`open_time` / `start_time` / `end_time`）で実装する。
- 「未取得」か「情報なし」かを区別しにくくなるため、空文字は使わず `null` を使う。
- `body` はテンプレREADMEの条件を満たす場合にのみ設定する。
