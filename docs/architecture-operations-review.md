# 構成・生成ページ改善レビュー（拡張性 / 運用観点）

更新日: 2026-02-15

## 0. 合意済みの実施方針（2026-02-15）

本ドキュメントで提案した内容のうち、以下を「実施方針」として確定する。

1. 日付ページの0件日は **ページを生成したまま `noindex,follow`** とする。
2. 欠損率の閾値は当面 **warn=1% / fail=3%** を維持する。
3. 品質ゲートで fail 判定が出た場合は **CI失敗（マージ不可）** とする。

### 0-1. 欠損率の定義（運用で使う用語の統一）

- `title欠損率 = title欠損件数 / totalEvents`
- `date欠損率 = date欠損件数 / totalEvents`
- `date` は `date` / `date_from` / `date_to` のいずれか1つでも値があれば「欠損ではない」とみなす。

> 補足: 定義を先に固定しておくことで、アラート閾値の見直し時に「何を欠損と数えたか」がぶれない。

## 1. 対象と前提

このレビューは、`docs/` 配下の公開HTML、`scripts/` 配下の生成・実行設定、CIワークフローを確認して整理した改善案です。

---

## 2. 現状の強み

- 主要ページに `title` / `description` / `canonical` / OGP / Twitter メタが整備されている。
- 構造化データ（`WebSite` / `BreadcrumbList` / `ItemList`）が段階的に導入されている。
- 生成フローが `run-all.config.json` に集約され、タスク依存関係や共有出力の扱いが明示されている。
- SEO必須項目チェック（`scripts/common/check-seo-required.js`）があり、再発防止の仕組みがある。

---

## 3. 重要課題（優先度高）

### 3-1. 生成対象URLの増加に対する「インデックス方針」の自動判定が弱い

日付ページは大量生成されるため、イベント件数が少ない日や0件日の扱いが運用依存になると、
将来的にクロール効率が悪化しやすくなります。

#### 改善案

- 「0件日は noindex,follow」または「0件日は非生成」のどちらかに固定。
- ルールを `generate-date-pages.js` と sitemap 生成ロジックに同時実装。
- ルールに合わないURLはサイトマップから除外して、クロール予算を重要ページへ集中。

### 3-2. フロント依存（Leaflet + クラスタ）の可用性対策が薄い

トップページは地図UIへの依存度が高く、CDN障害や回線品質の影響で体験が崩れる可能性があります。

#### 改善案

- CDN失敗時に備えたローカル配信（または二段fallback）を準備。
- 初期表示時に「主要導線（地域・日付・施設名）」を地図より先に確実描画。
- JS失敗時でも最低限の一覧導線が維持できる構成を維持・拡張。

### 3-3. データ収集失敗時の「部分成功運用」の可視化不足

`scripts/common/run-all.js` には品質ゲートがありますが、
施設別失敗や欠損の「公開可否判断」が運用者へ十分に伝わらない可能性があります。

#### 改善案

- 施設ごとの取得件数・欠損率を1ファイルに集約した実行サマリーを毎回出力。
- しきい値超過時はCIを fail し、公開ブランチへマージ不可にする。
- 「失敗施設のみ前回データを温存」などフォールバック方針を明文化。

---

## 4. 中期課題（優先度中）

### 4-1. テンプレート共通化のさらなる推進

SEO必須チェックはある一方で、ページ種別ごとの差分が増えると保守コストが上がります。

#### 改善案

- head生成ロジック（canonical/OGP/Twitter/JSON-LD）を共通ビルダー関数へ統一。
- 例外ページのみ allowlist で管理。

### 4-2. 施設・日付ページの内部リンク文脈強化

「詳細を見る」系リンクはUX上わかりやすい反面、文脈SEOの面では改善余地があります。

#### 改善案

- 主要リンクの一部を「{施設名}のイベント詳細」のような文脈付き文言に置換。
- パンくずと関連リンクの構造をページ種別で統一。

### 4-3. サイトマップ運用の将来拡張

URL増加に備え、単一sitemapから index + 分割sitemapへ移行すると運用安定性が上がります。

#### 改善案

- `sitemap-index.xml` + 種別（date/facility/spot）への分割。
- 差分更新（lastmod）を生成時に自動計算。

---

## 5. 運用改善（優先度中〜低）

- Search Consoleで `/date/`, `/facility/`, `/spot/` の表示回数/CTR/平均順位を週次記録。
- 重大指標（クロール済み未登録、重複、モバイルユーザビリティ）を定例監視。
- 取得元サイト仕様変更を想定し、スクレイピング失敗の検知アラートを追加。

---

## 6. 直近の実行順（推奨）

1. 日付ページのインデックス基準（0件日の扱い）をコード化
2. run-all実行サマリー（施設別成功/失敗/欠損率）を標準出力
3. CDNフォールバック方針の導入
4. sitemap分割の実装
5. Search Console KPIの週次運用開始
